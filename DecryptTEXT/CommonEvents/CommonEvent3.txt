CommonEvent 3
Name = "MYSTERY BOX"

  Script(["$PU_AUTOMATIC_POPUP = false"])
  Comment(["#############"])
  Script(["@itS = 1777"])
  ScriptMore(["@arS = 1778"])
  ScriptMore(["@weS = 1779"])
  ConditionalBranch([0, 2848, 0])
    Comment(["AcRemove"])
    Script(["$game_variables[1776] = Array.new(11, 0)"])
    ShotBalloonIcon([-1, 8, false])
    Wait([15])
    FadeoutScreen([])
    Wait([60])
    Comment(["##########"])
    ControlVariables([586, 586, 0, 1, 584])
    ControlVariables([584, 584, 0, 0, 0])
    CallCommonEvent([54])
    Comment(["##########"])
    ShowTextAttributes(["", 0, 0, 2])
    ShowText(["You wave goodbye to your team."])
    CallCommonEvent([90])
    Script(["@i = 0"])
    ScriptMore(["while $game_party.members.size > 1"])
    ScriptMore(["@ac = $game_party.members[1].id"])
    ScriptMore(["if @ac != 1"])
    ScriptMore(["$game_party.remove_actor(@ac)"])
    ScriptMore(["$game_variables[1776][@i] = @ac"])
    ScriptMore(["end"])
    ScriptMore(["@i += 1"])
    ScriptMore(["end"])
    ShowTextAttributes(["", 0, 0, 2])
    ShowText(["This is a trip to do alone."])
    Wait([60])
    FadeinScreen([])
    Wait([15])
    Comment(["Strings"])
    Script(["@itS = 1930"])
    ScriptMore(["@arS = 1931"])
    ScriptMore(["@weS = 1932"])
    Script(["@st = @itS"])
    Comment(["Rem Equip"])
    Script(["@selfFix = [671,672,673,692,699]"])
    ScriptMore(["@slot = 0"])
    ScriptMore(["while @slot < 6"])
    ScriptMore(["@eId = $game_actors[1].equips[@slot].id rescue 0"])
    ScriptMore(["if !@selfFix.include?@eId"])
    ScriptMore(["$game_actors[1].change_equip_by_id(@slot,0)"])
    ScriptMore(["end"])
    ScriptMore(["@slot += 1"])
    ScriptMore(["end"])
    JumpToLabel(["BOXXXIT"])
    Empty([])

  BranchEnd([])
  ConditionalBranch([0, 2849, 0])
    Comment(["AcRetake"])
    ShotBalloonIcon([-1, 8, false])
    Wait([15])
    FadeoutScreen([])
    Wait([60])
    Comment(["##########"])
    ControlVariables([584, 584, 0, 1, 586])
    CallCommonEvent([54])
    Comment(["##########"])
    ConditionalBranch([12, "$game_map.map_id != 530"])
      ShowTextAttributes(["", 0, 0, 2])
      ShowText(["You welcome your companions back."])
      Empty([])

    BranchEnd([])
    Script(["@i = 0"])
    ScriptMore(["while @i < 5"])
    ScriptMore(["@ac = $game_variables[1776][@i]"])
    ScriptMore(["if @ac != 0"])
    ScriptMore(["$game_party.add_actor(@ac)"])
    ScriptMore(["end"])
    ScriptMore(["@i += 1"])
    ScriptMore(["end"])
    ConditionalBranch([12, "$game_map.map_id != 530"])
      Wait([60])
      FadeinScreen([])
      Wait([15])
      Empty([])

    BranchEnd([])
    Script(["@itS = 1930"])
    ScriptMore(["@arS = 1931"])
    ScriptMore(["@weS = 1932"])
    Script(["@st = @itS"])
    JumpToLabel(["UNBOXXXIT"])
    Empty([])

  BranchEnd([])
  Comment(["#############"])
  CallCommonEvent([242])
  ControlSwitches([1770, 1770, 0])
  ConditionalBranch([0, 2170, 0])
    ControlSwitches([2170, 2170, 1])
    ShowTextAttributes(["", 0, 0, 2])
    ShowText(["The \\i[593] \\c[18]MYSTERY BOX\\c[0] opens!"])
    ShowTextAttributes(["", 0, 0, 2])
    ShowText(["You take back the items you put in there. "])
    Label(["UNBOXXXIT"])
    Script(["@st = @itS"])
    Script(["@n = 0"])
    Comment(["###TAKING BACK###"])
    Loop([])
      Script(["@okch = $game_variables[@st][@n] rescue -1"])
      ConditionalBranch([12, "@okch.nil?"])
        JumpToLabel(["takenex"])
        Empty([])

      BranchEnd([])
      ConditionalBranch([12, "@okch > 0"])
        Script(["@val = $game_variables[@st][@n]"])
        Script(["@q = @val "])
        Script(["@q /= 1000"])
        Script(["@i = @val "])
        Script(["@i %= 1000"])
        ConditionalBranch([12, "@st == @itS"])
          Comment(["---------------------------------------"])
          ConditionalBranch([0, 2849, 0])
            Comment(["MYSTERY / GobPack / RoseNote"])
            Script(["@skip = [20,23,42,60,62,63,64,65,66,82,46,47,48,49,50,51,52,53,54,83,90,"])
            ScriptMore(["91,96,97,108,110,200,209,213,276,283,286,296,320,273,187,188,221,377,362,363,"])
            ScriptMore(["364,429,430,431,477,325,355,357,387,358,393,19,383,221,377,429,430,431,477,187,188,"])
            ScriptMore(["489,490,479]"])
            Script(["@skip = [486,487]"])
            Comment(["drop DIARIES too"])
            Script(["@diaries = [72,74,73,80,84,85,86,87,88,89,98,99,219,226,281,285,326,351,"])
            ScriptMore(["375,395,420,478]"])
            Empty([])

          Else([])
            Comment(["keep MYSTERY BOX"])
            Script(["@skip = [20,23,42,56,60,62,63,64,65,66,81,82,46,47,48,49,50,51,52,53,54,83,90,"])
            ScriptMore(["91,96,97,108,110,200,209,213,276,283,286,296,320,273,187,188,221,377,383,362,363,"])
            ScriptMore(["364,429,430,431,477,325,355,357,387,358,393,19,383,221,377,429,430,431,477,187,188,"])
            ScriptMore(["489,490,479,486,487]"])
            Comment(["drop DIARIES too"])
            Script(["@diaries = [72,74,73,80,84,85,86,87,88,89,98,99,219,226,281,285,326,351,"])
            ScriptMore(["375,395,420,478]"])
            Empty([])

          BranchEnd([])
          ConditionalBranch([12, "@diaries.include?@i"])
            Empty([])

          BranchEnd([])
          ConditionalBranch([12, "@skip.include?@i"])
            JumpToLabel(["skipTake"])
            Empty([])

          BranchEnd([])
          Comment(["---------------------------------------"])
          Script(["@ic = $data_items[@i].icon_index rescue nil"])
          ConditionalBranch([12, "@ic != nil && @ic != 0"])
            Script(["$game_party.gain_item($data_items[@i], @q)"])
            Empty([])

          BranchEnd([])
          Empty([])

        BranchEnd([])
        ConditionalBranch([12, "@st == @arS"])
          Script(["@ic = $data_armors[@i].icon_index rescue nil"])
          Comment(["---------------------------------------"])
          Script(["@skip = [273,667,668,669,670,750,751,752,753,754,755,756,757,758]"])
          ConditionalBranch([12, "@skip.include?@i"])
            JumpToLabel(["skipTake"])
            Empty([])

          BranchEnd([])
          Comment(["---------------------------------------"])
          ConditionalBranch([12, "@ic != nil && @ic != 0"])
            Script(["$game_party.gain_item($data_armors[@i], @q)"])
            Empty([])

          BranchEnd([])
          Empty([])

        BranchEnd([])
        ConditionalBranch([12, "@st == @weS"])
          Script(["@ic=$data_weapons[@i].icon_index rescue nil"])
          ConditionalBranch([12, "@i == 105"])
            Comment(["catalyst dagger"])
            JumpToLabel(["skipTake"])
            Empty([])

          BranchEnd([])
          ConditionalBranch([12, "@ic != nil && @ic != 0"])
            Script(["$game_party.gain_item($data_weapons[@i], @q)"])
            Empty([])

          BranchEnd([])
          Empty([])

        BranchEnd([])
        Empty([])

      Else([])
        JumpToLabel(["takenex"])
        Empty([])

      BranchEnd([])
      Label(["skipTake"])
      Script(["@n += 1"])
      ConditionalBranch([12, "@n >= 1000"])
        Label(["takenex"])
        ConditionalBranch([12, "@st == @weS"])
          BreakLoop([])
          Empty([])

        BranchEnd([])
        ConditionalBranch([12, "@st == @arS"])
          Script(["@st = @weS"])
          Script(["@n = 0"])
          Empty([])

        BranchEnd([])
        ConditionalBranch([12, "@st == @itS"])
          Script(["@st = @arS"])
          Script(["@n = 0"])
          Empty([])

        BranchEnd([])
        Empty([])

      Else([])
        Empty([])

      BranchEnd([])
      Comment(["###TAKING BACK### END"])
      Empty([])

    RepeatAbove([])
    JumpToLabel(["end"])
    Empty([])

  BranchEnd([])
  ConditionalBranch([0, 2168, 0])
    ShowTextAttributes(["", 0, 0, 2])
    ShowText(["You've already closed the \\i[593] \\c[18]MYSTERY BOX\\c[0] during this playthrough."])
    JumpToLabel(["end"])
    Empty([])

  BranchEnd([])
  ConditionalBranch([2, "A", 1])
    ControlSelfSwitch(["A", 0])
    ShowTextAttributes(["", 0, 0, 2])
    ShowText(["The \\i[593] \\c[18]MYSTERY BOX\\c[0] can be used to bring your inventory everywhere,\\. \\c[18]even through space and time\\c[0]!"])
    ShowTextAttributes(["", 0, 0, 2])
    ShowText(["It'll gulp down everything you're not equipping!\\.\\. Be aware you won't be able to use those items anymore,\\. until the \\i[593] \\c[18]MYSTERY BOX\\c[0] unlocks herself."])
    ShowTextAttributes(["", 0, 0, 2])
    ShowText(["Try it out!\\.\\. The \\i[593] \\c[18]MYSTERY BOX\\c[0] is a safe,\\. child-friendly toy!\\.\\. Just make sure your hand doesn't get caught in it as it closes~!"])
    Wait([15])
    Empty([])

  BranchEnd([])
  ShowTextAttributes(["", 0, 0, 2])
  ShowText(["Do you want to use the \\i[593] \\c[18]MYSTERY BOX\\c[0] now?"])
  ShowChoices([["Yes", "No"], 2])
  When([0, "Yes"])
    Empty([])

  When([1, "No"])
    JumpToLabel(["end"])
    Empty([])

  ChoicesEnd([])
  Comment(["EXTRAS"])
  Script(["$game_variables[1776] = Array.new(1000, 0)"])
  Label(["BOXXXIT"])
  Comment(["ITEMS"])
  Script(["$game_variables[@itS] = Array.new(1000, 0)"])
  Comment(["ARMORS"])
  Script(["$game_variables[@arS] = Array.new(1000, 0)"])
  Comment(["WEAPONS"])
  Script(["$game_variables[@weS] = Array.new(1000, 0)"])
  Comment(["###STORING###"])
  Script(["@st = @itS"])
  Script(["@n = 0"])
  Script(["@i = 1"])
  Comment(["###STORING###"])
  Loop([])
    ConditionalBranch([12, "@st == @itS"])
      Script(["@q = $game_party.item_number($data_items[@i])"])
      Comment(["---------------------------------------"])
      ConditionalBranch([0, 2848, 0])
        Comment(["MYSTERY / GobPack / RoseNote / ShadRec too"])
        Script(["@skip = [20,23,42,60,62,63,64,65,66,82,46,47,48,49,50,51,52,53,54,83,90,"])
        ScriptMore(["91,96,97,108,110,200,209,213,276,283,286,296,320,273,187,188,221,377,362,363,"])
        ScriptMore(["364,429,430,431,477,325,355,357,387,358,393,19,383,221,377,429,430,431,477,187,188,"])
        ScriptMore(["489,490,479]"])
        Script(["@skip = [486,487]"])
        Comment(["drop DIARIES too"])
        Script(["@diaries = [72,74,73,80,84,85,86,87,88,89,98,99,219,226,281,285,326,351,"])
        ScriptMore(["375,395,420,478]"])
        Empty([])

      Else([])
        Comment(["keep MYSTERY BOX"])
        Script(["@skip = [20,23,42,56,60,62,63,64,65,66,81,82,46,47,48,49,50,51,52,53,54,83,90,"])
        ScriptMore(["91,96,97,108,110,200,209,213,276,283,286,296,320,273,187,188,221,377,383,362,363,"])
        ScriptMore(["364,429,430,431,477,325,355,357,387,358,393,19,383,221,377,429,430,431,477,187,188,"])
        ScriptMore(["489,490,479,486,487]"])
        Comment(["drop DIARIES too"])
        Script(["@diaries = [72,74,73,80,84,85,86,87,88,89,98,99,219,226,281,285,326,351,"])
        ScriptMore(["375,395,420,478]"])
        Empty([])

      BranchEnd([])
      ConditionalBranch([12, "@diaries.include?@i"])
        Empty([])

      BranchEnd([])
      ConditionalBranch([12, "@skip.include?@i"])
        JumpToLabel(["skip"])
        Empty([])

      BranchEnd([])
      Comment(["---------------------------------------"])
      Empty([])

    BranchEnd([])
    ConditionalBranch([12, "@st == @arS"])
      Script(["@q = $game_party.item_number($data_armors[@i])"])
      Comment(["---------------------------------------"])
      Script(["@skip = [273,667,668,669,670,750,751,752,753,754,755,756,757,758]"])
      ConditionalBranch([12, "@skip.include?@i"])
        JumpToLabel(["skip"])
        Empty([])

      BranchEnd([])
      Comment(["---------------------------------------"])
      Empty([])

    BranchEnd([])
    ConditionalBranch([12, "@st == @weS"])
      Script(["@q = $game_party.item_number($data_weapons[@i])"])
      ConditionalBranch([12, "@i == 105"])
        Comment(["cat dagger"])
        JumpToLabel(["skip"])
        Empty([])

      BranchEnd([])
      Empty([])

    BranchEnd([])
    ConditionalBranch([12, "@q >= 1"])
      ConditionalBranch([12, "@st == @itS"])
        Script(["$game_party.lose_item($data_items[@i], @q)"])
        Empty([])

      BranchEnd([])
      ConditionalBranch([12, "@st == @arS"])
        Script(["$game_party.lose_item($data_armors[@i], @q)"])
        Empty([])

      BranchEnd([])
      ConditionalBranch([12, "@st == @weS"])
        Script(["$game_party.lose_item($data_weapons[@i], @q)"])
        Empty([])

      BranchEnd([])
      Script(["$game_variables[@st][@n] = 1000"])
      Script(["$game_variables[@st][@n] *= @q"])
      Script(["$game_variables[@st][@n] += @i"])
      Script(["@n += 1"])
      Empty([])

    BranchEnd([])
    Label(["skip"])
    Script(["@i += 1"])
    ConditionalBranch([12, "@i >= 1000 || @n >= 1000"])
      ConditionalBranch([12, "@st == @weS"])
        BreakLoop([])
        Empty([])

      BranchEnd([])
      ConditionalBranch([12, "@st == @arS"])
        Script(["@st = @weS"])
        Script(["@i = 1"])
        Script(["@n = 0"])
        Empty([])

      BranchEnd([])
      ConditionalBranch([12, "@st == @itS"])
        Script(["@st = @arS"])
        Script(["@i = 1"])
        Script(["@n = 0"])
        Empty([])

      BranchEnd([])
      Empty([])

    BranchEnd([])
    Empty([])

  RepeatAbove([])
  Comment(["###STORING### END"])
  ConditionalBranch([0, 2848, 0])
    Comment(["AcRemove"])
    JumpToLabel(["end"])
    Empty([])

  BranchEnd([])
  ConditionalBranch([0, 2849, 0])
    JumpToLabel(["end"])
    Empty([])

  BranchEnd([])
  ShowTextAttributes(["", 0, 0, 2])
  ShowText(["The \\i[593] \\c[18]MYSTERY BOX\\c[0] closes.\\.\\. You won't be able to open it until your next playthrough."])
  ControlSwitches([2168, 2168, 0])
  ControlSwitches([2169, 2169, 0])
  Label(["end"])
  ControlSwitches([2171, 2171, 1])
  ControlSwitches([1770, 1770, 1])
  CallCommonEvent([243])
  Script(["$PU_AUTOMATIC_POPUP = true"])
  Empty([])
